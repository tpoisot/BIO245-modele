name: Compilation
on:
    push:
        branches: ["main"]

jobs:
    compilation:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                julia-version: [1]
                os: [ubuntu-latest]
        steps:
            - uses: actions/checkout@v4
            - name: "Set up Julia"
              uses: julia-actions/setup-julia@v2
              with:
                  version: ${{ matrix.julia-version }}
            - name: "Add Literate"
              run: julia -e 'import Pkg; Pkg.activate("."); Pkg.instantiate(); Pkg.add("Literate")'
              shell: bash
            - name: "Execute the document"
              run: julia --project .assets/build.jl
              shell: bash
            - name: "Get the fonts"
              run: |
                  wget https://github.com/alerque/libertinus/releases/download/v7.051/Libertinus-7.051.zip
                  unzip Libertinus-7.051.zip
                  mkdir -p ~/.fonts/
                  mv Libertinus-7.051/static/OTF/*.otf ~/.fonts/
                  fc-cache -fv
            - name: "Download Typst"
              run: |
                  wget https://github.com/typst/typst/releases/download/v0.14.1/typst-x86_64-unknown-linux-musl.tar.xz
                  tar -xvf typst-x86_64-unknown-linux-musl.tar.xz
            - name: "Install pandoc"
              uses: pandoc/actions/setup@v1
            - name: "Run pandoc"
              run: pandoc travail.md --pdf-engine=./typst-x86_64-unknown-linux-musl/typst -o docs/travail.pdf --template=.assets/template.typ
            - name: Upload the PDF
              uses: actions/upload-artifact@v4
              with:
                  name: Travail
                  path: docs/travail.pdf
            - name: Prepare the web pages
              id: deployment
              uses: actions/upload-artifact@v4
              with:
                  path: docs/
    publication:
        runs-on: ubuntu-latest
        needs: compilation
        permissions:
            pages: write
            id-token: write
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Deploy to GitHub pages
              id: deployment
              uses: actions/deploy-pages@v4
